<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Us | CrimeEye</title>
  <link rel="stylesheet" href="Contact Us.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
  integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
  crossorigin=""></script> 
  <style>
    #map { height: 100%; }
  </style>
</head>
<body>
  <header>
    <div class="banner">
        <div class="banner-links">
          <a href="main.html" class="banner-link">Map</a>
          <a href="About Us.html" class="banner-link">About Us</a>
        </div>
        <div class="banner-logo">
          <a href="index.html"><img src="images/logo.png" alt="CrimeEye Logo"></a>
        </div>
        <div class="banner-links">
          <a href="#" class="banner-link">Our Mission</a>
          <a href="Contact Us.html" class="banner-link">Contact Us</a>
        </div>
    </div>      
  </header>
  <div id='map'>
  </div>
  <script>

    var map = L.map('map', {
      zoomControl: false, // Add zoom control separately below
      center: [34.05, -118.24], // Initial map center
      zoom: 10, // Initial zoom level
      attributionControl: false, // Instead of default attribution, we add custom at the bottom of script
      scrollWheelZoom: false
    })

    // Add zoom in/out buttons to the top-right
    L.control.zoom({position: 'topright'}).addTo(map)

    // Add baselayer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map)

    // Add geographical labels only layer on top of baselayer
    var labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19,
      pane: 'shadowPane'  // always display on top
    }).addTo(map)

    // Read data from CSV file
    $.get('./data/data.csv', function(csvString) {

      // Use PapaParse to transform file into arrays
      var data = Papa.parse(csvString.trim()).data.filter(
        function(row) { return row.length === 2 }
      ).map(function(a) {
        return [ parseFloat(a[0]), parseFloat(a[1]) ]
      })

      // Add all points into a heat layer
      var heat = L.heatLayer(data, {
        radius: 5,
        blur: 8,
      })

      // Add the heatlayer to the map
      heat.addTo(map)

      // Define a function to update the heatmap layer with new data
      function updateHeatmap(columnIndex) {
        var newDataPoints = []; // Initialize empty array for new data points
        for (var i = 0; i < data.length; i++) {
          newDataPoints.push([data[i][0], data[i][columnIndex]]); // Extract the lat/long and column value for the selected column
        }
        heat.setLatLngs(newDataPoints); // Update the heatmap layer with the new data points
      }

      // Add a UI element to let the user toggle between different columns
      var columnSelect = document.getElementById('column-select');
      columnSelect.addEventListener('change', function() {
        var columnIndex = parseInt(this.value); // Get the index of the selected column
        updateHeatmap(columnIndex); // Update the heatmap layer with the selected column
      });

    })

    // Add custom attribution
    L.control.attribution({
      prefix: '<a href="https://github.com/HandsOnDataViz/leaflet-heatmap">View data and code</a> \
        by <a href="https://handsondataviz.org" target="_blank">HandsOnDataViz</a>'
    }).addTo(map)

    // Get a reference to the incident report form
var incidentForm = document.getElementById('incident-form');

// Add an event listener to the map that listens for a click event
map.on('click', function(e) {
  // Get the latitude and longitude of the click location
  var lat = e.latlng.lat;
  var lng = e.latlng.lng;

  // Populate the location field of the incident report form with the latitude and longitude values
  incidentForm.location.value = lat + ', ' + lng;

  // Display the incident report form to the user
  incidentForm.style.display = 'block';
});

// Add an event listener to the incident report form that listens for a submit event
incidentForm.addEventListener('submit', function(e) {
  // Prevent the default form submission behavior
  e.preventDefault();

// Create an empty layer group for the incident report markers
var incidentMarkers = L.layerGroup().addTo(map);

// Make an AJAX request to retrieve the incident report data from the server-side script
var xhr = new XMLHttpRequest();
xhr.open('GET', '/get-incident-reports.php');
xhr.onload = function() {
  if (xhr.status === 200) {
    // The request was successful, so parse the JSON response and create markers for each incident report
    var incidentReports = JSON.parse(xhr.responseText);
    for (var i = 0; i < incidentReports.length; i++) {
      var incidentReport = incidentReports[i];

      // Create a marker for the incident report and add it to the incidentMarkers layer group
      var marker = L.marker([incidentReport.latitude, incidentReport.longitude]).addTo(incidentMarkers);

      // Add a popup to the marker with the incident report details
      marker.bindPopup('<b>Incident:</b> ' + incidentReport.incident + '<br><b>Description:</b> ' + incidentReport.description + '<br><b>Time:</b> ' + incidentReport.time);
    }
  } else {
    // The request failed, so display an error message to the user
    alert('An error occurred while retrieving the incident reports. Please try again later.');
  }
};
xhr.send();

  // Get the form data
  var formData = new FormData(incidentForm);

  // Send the form data to the server-side script using an HTTP request
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/process-incident-report.php');
  xhr.onload = function() {
    if (xhr.status === 200) {
      // The request was successful, so hide the incident report form from the user
      incidentForm.style.display = 'none';
    } else {
      // The request failed, so display an error message to the user
      alert('An error occurred while processing your incident report. Please try again later.');
    }
  };
  xhr.send(formData);
});
  </script>
</body>
</html>